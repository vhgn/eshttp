name: Publish Packages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      publish_core: ${{ steps.detect.outputs.publish_core }}
      publish_cli: ${{ steps.detect.outputs.publish_cli }}
      core_version: ${{ steps.detect.outputs.core_version }}
      cli_version: ${{ steps.detect.outputs.cli_version }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Detect publishable version changes
        id: detect
        run: |
          core_name=$(node -p "JSON.parse(require('fs').readFileSync('libs/core/package.json','utf8')).name")
          core_version=$(node -p "JSON.parse(require('fs').readFileSync('libs/core/package.json','utf8')).version")
          core_published=$(npm view "$core_name" version 2>/dev/null || true)

          if [ -z "$core_published" ] || [ "$core_published" != "$core_version" ]; then
            echo "publish_core=true" >> "$GITHUB_OUTPUT"
          else
            echo "publish_core=false" >> "$GITHUB_OUTPUT"
          fi

          cli_name=$(node -p "JSON.parse(require('fs').readFileSync('apps/cli/package.json','utf8')).name")
          cli_version=$(node -p "JSON.parse(require('fs').readFileSync('apps/cli/package.json','utf8')).version")
          cli_published=$(npm view "$cli_name" version 2>/dev/null || true)

          if [ -z "$cli_published" ] || [ "$cli_published" != "$cli_version" ]; then
            echo "publish_cli=true" >> "$GITHUB_OUTPUT"
          else
            echo "publish_cli=false" >> "$GITHUB_OUTPUT"
          fi

          echo "core_version=$core_version" >> "$GITHUB_OUTPUT"
          echo "cli_version=$cli_version" >> "$GITHUB_OUTPUT"

  publish_core:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.publish_core == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build core
        working-directory: libs/core
        run: bun run build

      - name: Publish core
        working-directory: libs/core
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish_cli:
    runs-on: ubuntu-latest
    needs:
      - detect
      - publish_core
    if: needs.detect.outputs.publish_cli == 'true' && (needs.publish_core.result == 'success' || needs.publish_core.result == 'skipped')
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build core
        working-directory: libs/core
        run: bun run build

      - name: Build cli
        working-directory: apps/cli
        run: bun run build

      - name: Pin published core dependency version for CLI
        run: npm pkg set dependencies.eshttp-core="^${{ needs.detect.outputs.core_version }}"
        working-directory: apps/cli

      - name: Publish cli
        working-directory: apps/cli
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
