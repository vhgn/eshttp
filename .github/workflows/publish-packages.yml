name: Publish Packages

on:
  release:
    types:
      - created
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to simulate (e.g. core-v1.2.3 or cli-v1.2.3)
        required: false
        type: string

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      publish_core: ${{ steps.detect.outputs.publish_core }}
      publish_cli: ${{ steps.detect.outputs.publish_cli }}
      release_version: ${{ steps.detect.outputs.release_version }}
    steps:
      - name: Detect release target from tag
        id: detect
        env:
          TAG_NAME: ${{ inputs.release_tag || github.event.release.tag_name || github.ref_name }}
        run: |
          tag="$TAG_NAME"
          semver='[0-9]+\.[0-9]+\.[0-9]+([-][0-9A-Za-z.-]+)?([+][0-9A-Za-z.-]+)?'

          if [[ "$tag" =~ ^core[-/]v?($semver)$ ]] || [[ "$tag" =~ ^eshttp-core@v?($semver)$ ]]; then
            target="core"
            version="${BASH_REMATCH[1]}"
          elif [[ "$tag" =~ ^cli[-/]v?($semver)$ ]] || [[ "$tag" =~ ^eshttp@v?($semver)$ ]]; then
            target="cli"
            version="${BASH_REMATCH[1]}"
          else
            echo "Unsupported release tag '$tag'. Use core-vX.Y.Z or cli-vX.Y.Z."
            exit 1
          fi

          echo "publish_core=$([ "$target" = "core" ] && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "publish_cli=$([ "$target" = "cli" ] && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "release_version=$version" >> "$GITHUB_OUTPUT"

  publish_core:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.publish_core == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build core
        working-directory: libs/core
        run: bun run build

      - name: Set core version from release tag
        run: npm version "${{ needs.detect.outputs.release_version }}" --no-git-tag-version
        working-directory: libs/core

      - name: Publish core
        working-directory: libs/core
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish_cli:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.publish_cli == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build core
        working-directory: libs/core
        run: bun run build

      - name: Build cli
        working-directory: apps/cli
        run: bun run build

      - name: Set CLI version from release tag
        run: npm version "${{ needs.detect.outputs.release_version }}" --no-git-tag-version
        working-directory: apps/cli

      - name: Pin published core dependency version for CLI
        run: npm pkg set dependencies.eshttp-core="^${{ needs.detect.outputs.release_version }}"
        working-directory: apps/cli

      - name: Publish cli
        working-directory: apps/cli
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
